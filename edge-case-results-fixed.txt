Starting edge case test suite...

════════════════════════════════════════════════════════════════════════════════
  DCS EDGE CASE TEST SUITE
════════════════════════════════════════════════════════════════════════════════


────────────────────────────────────────────────────────────────────────────────
TEST 1/25: Concurrent Procedures [CONCURRENT]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'HYDROCEPHALUS', complexity: 1 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'HYDROCEPHALUS', consultants: 0, complexity: 1 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:735:1
    at ModuleJob.run (node:internal/modules/esm/module_job:345:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:665:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'HYDROCEPHALUS', 'TBI_CSDH' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'HYDROCEPHALUS',
  consultants: 0,
  hasPTOT: false,
  complexity: 1
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:53:05.781Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:53:05.781Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 58, gender: 'F' },
  dates: {
    ictusDate: '2025-01-15',
    admissionDate: '2025-01-15',
    dischargeDate: '2025-01-25'
  },
  pathology: {
    type: 'SDH',
    location: 'right',
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'fall' ],
  procedures: [
    {
      name: 'right frontoparietal craniotomy for SDH evacuation',
      date: '2025-01-15',
      operator: null
    },
    {
      name: 'ICP monitor placement',
      date: '2025-01-15',
      operator: null
    },
    { name: 'EVD insertion', date: '2025-01-15', operator: null }
  ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:05.781Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:05.781Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (56.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: HYDROCEPHALUS
[Phase 1 Step 6] Detecting subtype for: TBI_CSDH
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 5 procedure mentions (before deduplication)
[Temporal] Separated: 5 new events, 0 references
[Semantic Dedup] Starting deduplication for 5 procedures...
[Semantic Dedup] Created 3 semantic clusters
[Semantic Dedup] Processing cluster with 2 entities: craniotomy, craniotomy
[Semantic Dedup] Merged 2 entities on no_date → "craniotomy"
[Semantic Dedup] Processing cluster with 2 entities: ICP monitor placement, ICP monitor placement
[Semantic Dedup] Merged 2 entities on no_date → "ICP monitor placement"
[Semantic Dedup] Deduplication complete: 5 → 3 procedures
[Semantic Dedup] Procedures: 5 → 3 (40.0% reduction)
[Semantic Dedup] Merged 2 procedure groups (avg 2.0 per group)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 3 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 3 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'HYDROCEPHALUS', consultants: 0, complexity: 1 }
📊 Prompt optimization: Data 5968 → 174 chars, Notes 424 → 424 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 2 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 50.9%
[Phase 3] Quality score: 50.9%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 50.9%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 15455ms
[Orchestrator] Final quality: 50.9%
❌ FAILED
   Quality: N/A% (expected: 40%)
   Duration: 15.5s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 2/25: Complication During Procedure [CONCURRENT]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TUMORS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TUMORS' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'tumor.histology',
    reason: 'Histology determines prognosis and treatment plan',
    priority: 'critical',
    whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
    clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
    relatedFields: [ 'tumor.whoGrade', 'molecularMarkers', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:53:21.093Z'
  },
  {
    field: 'tumor.whoGrade',
    reason: 'WHO grade is essential for prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
    clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
    relatedFields: [ 'tumor.histology', 'adjuvantTherapy', 'followUpSchedule' ],
    timestamp: '2025-10-16T17:53:21.093Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:53:21.093Z'
  },
  {
    field: 'resectionExtent',
    reason: 'Extent of resection affects survival and recurrence risk',
    priority: 'high',
    whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
    clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
    relatedFields: [ 'postopMRI', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:53:21.093Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:53:21.093Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 67, gender: 'M' },
  dates: {
    ictusDate: null,
    admissionDate: '2025-02-10',
    dischargeDate: '2025-02-20'
  },
  pathology: {
    type: 'brain tumor',
    location: 'left temporal',
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [
    {
      name: 'left temporal craniotomy for tumor resection',
      date: '2025-02-11',
      operator: null
    }
  ],
  complications: [
    {
      name: 'intraoperative hemorrhage',
      date: '2025-02-11',
      severity: 'significant',
      management: 'emergency hemostasis'
    }
  ],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Rehab', support: null },
  _suggestions: [
    {
      field: 'tumor.histology',
      reason: 'Histology determines prognosis and treatment plan',
      priority: 'critical',
      whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
      clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:21.093Z'
    },
    {
      field: 'tumor.whoGrade',
      reason: 'WHO grade is essential for prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
      clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:21.093Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:21.093Z'
    },
    {
      field: 'resectionExtent',
      reason: 'Extent of resection affects survival and recurrence risk',
      priority: 'high',
      whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
      clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:21.093Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:21.093Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (57.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TUMORS
[Phase 1 Step 6] Detected TUMORS subtype: {
  whoGrade: 'WHO Grade IV',
  treatment: [
    'Maximal safe resection',
    'Stupp protocol: RT + concurrent/adjuvant TMZ',
    'TTFields if eligible'
  ],
  molecularMarkers: []
}
[Phase 1 Step 6] Subtype detection complete:
        - Type: TUMORS
        - Risk Level: VERY HIGH
        - Details: {
  "whoGrade": "WHO Grade IV",
  "treatment": [
    "Maximal safe resection",
    "Stupp protocol: RT + concurrent/adjuvant TMZ",
    "TTFields if eligible"
  ],
  "molecularMarkers": []
}
        - Prognosis: {
  "survival": "17 months median survival",
  "malignancy": "Highly malignant",
  "growth": "Aggressive, necrosis, vascular proliferation",
  "factors": [
    "STR: +10% survival"
  ]
}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 4 procedure mentions (before deduplication)
[Temporal] Separated: 4 new events, 0 references
[Semantic Dedup] Starting deduplication for 4 procedures...
[Semantic Dedup] Created 3 semantic clusters
[Semantic Dedup] Processing cluster with 2 entities: resection, resection
[Semantic Dedup] Merged 2 entities on no_date → "tumor resection"
[Semantic Dedup] Deduplication complete: 4 → 3 procedures
[Semantic Dedup] Procedures: 4 → 3 (25.0% reduction)
[Semantic Dedup] Merged 1 procedure groups (avg 2.0 per group)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 3 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 1 complication mentions (before deduplication)
[Temporal] Separated: 1 new complications, 0 references
[Semantic Dedup] Starting deduplication for 1 complications...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 complications
[Semantic Dedup] Complications: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 1 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 8992 → 234 chars, Notes 377 → 377 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.1%
[Phase 3] Quality score: 52.1%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.1%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 17302ms
[Orchestrator] Final quality: 52.1%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 17.3s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 3/25: Same-Day Medication Changes [CONCURRENT]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'SEIZURES', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'SEIZURES', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'SEIZURES' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'SEIZURES',
  consultants: 0,
  hasPTOT: false,
  complexity: 0
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:53:39.191Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:53:39.191Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: {
    ictusDate: '2025-03-01',
    admissionDate: '2025-03-01',
    dischargeDate: '2025-03-10'
  },
  pathology: {
    type: 'seizures',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'seizures' ],
  procedures: [],
  complications: [
    {
      name: 'breakthrough seizure',
      date: '2025-03-02',
      severity: null,
      management: 'increased levetiracetam dose and added lacosamide'
    }
  ],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [
    {
      name: 'levetiracetam',
      dose: '1000mg',
      frequency: 'BID',
      route: null
    },
    {
      name: 'lacosamide',
      dose: '100mg',
      frequency: 'BID',
      route: null
    }
  ],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:39.191Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:39.191Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (59.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: SEIZURES
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 3 complication mentions (before deduplication)
[Temporal] Separated: 3 new complications, 0 references
[Semantic Dedup] Starting deduplication for 3 complications...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Processing cluster with 3 entities: Seizure, Seizure, seizures
[Semantic Dedup] Merged 3 entities on no_date → "seizure"
[Semantic Dedup] Deduplication complete: 3 → 1 complications
[Semantic Dedup] Complications: 3 → 1 (66.7% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 1 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 5 medication mentions (before deduplication)
[Temporal] Separated: 5 new prescriptions, 0 references
[Semantic Dedup] Starting deduplication for 5 medications...
[Semantic Dedup] Created 3 semantic clusters
[Semantic Dedup] Processing cluster with 3 entities: levetiracetam, levetiracetam, Levetiracetam
[Semantic Dedup] Deduplication complete: 5 → 5 medications
[Semantic Dedup] Medications: 5 → 5 (0.0% reduction)
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 5 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 3 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 29.1%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'SEIZURES', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 4236 → 277 chars, Notes 289 → 289 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.9%
[Phase 3] Quality score: 51.9%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.9%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 17001ms
[Orchestrator] Final quality: 51.9%
❌ FAILED
   Quality: N/A% (expected: 40%)
   Duration: 17.0s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 4/25: Missing Admission Date [MISSING_DATES]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'SAH', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'SAH', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'SAH' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'SAH', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'gradingScales.huntHess',
    reason: 'Hunt-Hess grade is critical for SAH prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "Hunt-Hess", "H&H", "HH grade" in admission notes, neurosurgery consult, or imaging reports',
    clinicalSignificance: 'Predicts mortality: Grade 1-2 (10-20%), Grade 3 (30-40%), Grade 4-5 (60-80%). Guides ICU level of care.',
    relatedFields: [ 'gcs', 'neurologicalExam', 'admissionStatus' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  },
  {
    field: 'gradingScales.fisher',
    reason: 'Fisher grade predicts vasospasm risk - essential for monitoring plan',
    priority: 'critical',
    whereToFind: 'Look for: "Fisher", "Modified Fisher", "mFisher" in CT head reports or neurosurgery notes',
    clinicalSignificance: 'Grade 3 has 60-70% vasospasm risk. Determines TCD monitoring frequency and nimodipine duration.',
    relatedFields: [ 'imaging', 'vasospasmRisk', 'tcdMonitoring' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  },
  {
    field: 'aneurysm.location',
    reason: 'Aneurysm location affects treatment approach and follow-up',
    priority: 'high',
    whereToFind: 'Look for: "PCOM", "ACOM", "MCA", "basilar" in CTA/angiogram reports or operative notes',
    clinicalSignificance: 'Location determines surgical vs endovascular approach and recurrence risk.',
    relatedFields: [ 'procedure', 'imaging' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  },
  {
    field: 'aneurysm.size',
    reason: 'Aneurysm size affects rupture risk and treatment complexity',
    priority: 'high',
    whereToFind: 'Look for: size in mm in CTA/angiogram reports (e.g., "5mm aneurysm")',
    clinicalSignificance: 'Size >7mm = higher rupture risk. Larger aneurysms may require complex treatment.',
    relatedFields: [ 'aneurysm.location', 'procedure' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  },
  {
    field: 'medications.nimodipine',
    reason: 'Nimodipine is standard of care for SAH - should be documented',
    priority: 'high',
    whereToFind: 'Look for: "nimodipine", "Nimotop", "60mg q4h" in medication list',
    clinicalSignificance: 'Nimodipine reduces poor outcomes by 40%. Given for 21 days post-SAH.',
    relatedFields: [ 'medications', 'vasospasmPrevention' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:53:56.293Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 72, gender: 'M' },
  dates: { ictusDate: null, admissionDate: null, dischargeDate: null },
  pathology: {
    type: 'aSAH',
    location: 'PCOM aneurysm',
    huntHess: 3,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'SAH' ],
  procedures: [
    { name: 'angiogram', date: null, operator: null },
    { name: 'endovascular coiling', date: null, operator: null }
  ],
  complications: [
    {
      name: 'vasospasm',
      date: null,
      severity: null,
      management: 'triple-H therapy'
    }
  ],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [ 'PCOM aneurysm' ], dates: [ null ] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Rehab', support: null },
  _suggestions: [
    {
      field: 'gradingScales.huntHess',
      reason: 'Hunt-Hess grade is critical for SAH prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "Hunt-Hess", "H&H", "HH grade" in admission notes, neurosurgery consult, or imaging reports',
      clinicalSignificance: 'Predicts mortality: Grade 1-2 (10-20%), Grade 3 (30-40%), Grade 4-5 (60-80%). Guides ICU level of care.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    },
    {
      field: 'gradingScales.fisher',
      reason: 'Fisher grade predicts vasospasm risk - essential for monitoring plan',
      priority: 'critical',
      whereToFind: 'Look for: "Fisher", "Modified Fisher", "mFisher" in CT head reports or neurosurgery notes',
      clinicalSignificance: 'Grade 3 has 60-70% vasospasm risk. Determines TCD monitoring frequency and nimodipine duration.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    },
    {
      field: 'aneurysm.location',
      reason: 'Aneurysm location affects treatment approach and follow-up',
      priority: 'high',
      whereToFind: 'Look for: "PCOM", "ACOM", "MCA", "basilar" in CTA/angiogram reports or operative notes',
      clinicalSignificance: 'Location determines surgical vs endovascular approach and recurrence risk.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    },
    {
      field: 'aneurysm.size',
      reason: 'Aneurysm size affects rupture risk and treatment complexity',
      priority: 'high',
      whereToFind: 'Look for: size in mm in CTA/angiogram reports (e.g., "5mm aneurysm")',
      clinicalSignificance: 'Size >7mm = higher rupture risk. Larger aneurysms may require complex treatment.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    },
    {
      field: 'medications.nimodipine',
      reason: 'Nimodipine is standard of care for SAH - should be documented',
      priority: 'high',
      whereToFind: 'Look for: "nimodipine", "Nimotop", "60mg q4h" in medication list',
      clinicalSignificance: 'Nimodipine reduces poor outcomes by 40%. Given for 21 days post-SAH.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:53:56.293Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (55.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: SAH
[Phase 1 Step 6] Detected SAH subtype: {
  aneurysmLocation: 'Posterior Communicating Artery',
  locationRisks: [ 'CN III palsy', 'Carotid cave location' ],
  surgicalDifficulty: 'MODERATE'
}
[Phase 1 Step 6] Subtype detection complete:
        - Type: SAH
        - Risk Level: MODERATE
        - Details: {
  "aneurysmLocation": "Posterior Communicating Artery",
  "locationRisks": [
    "CN III palsy",
    "Carotid cave location"
  ],
  "surgicalDifficulty": "MODERATE"
}
        - Prognosis: {}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 4 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 4 references
[Reference Linking] Linked 0 of 4 references
[Phase 1 Step 5] Procedure extraction complete: 4 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 2 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 2 references
[Reference Linking] Linked 0 of 2 complication references
[Phase 1 Step 5] Complication extraction complete: 2 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 1 events, 0 relationships, 0 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 29.1%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'SAH', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 10413 → 204 chars, Notes 341 → 341 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.5%
[Phase 3] Quality score: 51.5%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.5%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 17499ms
[Orchestrator] Final quality: 51.5%
❌ FAILED
   Quality: N/A% (expected: 35%)
   Duration: 17.5s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 5/25: Only Relative Dates [MISSING_DATES]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'SPINE', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'SPINE', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'SPINE' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'SPINE', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'spineLevel',
    reason: 'Spinal level is essential for documentation and follow-up',
    priority: 'critical',
    whereToFind: 'Look for: "C5-6", "L4-5", cervical/thoracic/lumbar levels in operative note',
    clinicalSignificance: 'Level determines expected deficits, recovery, and hardware requirements.',
    relatedFields: [ 'neurologicalExam', 'procedure', 'hardware' ],
    timestamp: '2025-10-16T17:54:11.972Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:54:11.972Z'
  },
  {
    field: 'neurologicalExam.motorExam',
    reason: 'Motor exam is critical for spine surgery patients',
    priority: 'high',
    whereToFind: 'Look for: motor strength (0-5/5) by muscle group in daily notes or PT notes',
    clinicalSignificance: 'Documents baseline and tracks recovery. Essential for detecting postop deficits.',
    relatedFields: [ 'neurologicalExam', 'functionalStatus' ],
    timestamp: '2025-10-16T17:54:11.972Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:54:11.972Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: { ictusDate: null, admissionDate: null, dischargeDate: null },
  pathology: {
    type: 'degenerative spine',
    location: 'L4-L5',
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [
    {
      name: 'L4-L5 laminectomy and fusion',
      date: null,
      operator: null
    }
  ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'spineLevel',
      reason: 'Spinal level is essential for documentation and follow-up',
      priority: 'critical',
      whereToFind: 'Look for: "C5-6", "L4-5", cervical/thoracic/lumbar levels in operative note',
      clinicalSignificance: 'Level determines expected deficits, recovery, and hardware requirements.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:11.972Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:11.972Z'
    },
    {
      field: 'neurologicalExam.motorExam',
      reason: 'Motor exam is critical for spine surgery patients',
      priority: 'high',
      whereToFind: 'Look for: motor strength (0-5/5) by muscle group in daily notes or PT notes',
      clinicalSignificance: 'Documents baseline and tracks recovery. Essential for detecting postop deficits.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:11.972Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:11.972Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (49.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: SPINE
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 3 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 3 references
[Reference Linking] Linked 0 of 3 references
[Phase 1 Step 5] Procedure extraction complete: 3 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 0 events, 0 relationships, 0 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'SPINE', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 5758 → 160 chars, Notes 213 → 213 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 2 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 42.6%
[Phase 3] Quality score: 42.6%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 46.6%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 14992ms
[Orchestrator] Final quality: 46.6%
❌ FAILED
   Quality: N/A% (expected: 30%)
   Duration: 15.0s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 6/25: Contradictory Dates [MISSING_DATES]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'HYDROCEPHALUS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'HYDROCEPHALUS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'HYDROCEPHALUS' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'HYDROCEPHALUS',
  consultants: 0,
  hasPTOT: false,
  complexity: 0
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:54:28.231Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:54:28.231Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: {
    ictusDate: null,
    admissionDate: '2025-04-01',
    dischargeDate: '2025-04-05'
  },
  pathology: {
    type: 'hydrocephalus',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [ { name: 'VP shunt revision', date: '2025-03-30', operator: null } ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:28.231Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:28.231Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (53.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: HYDROCEPHALUS
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 2 procedure mentions (before deduplication)
[Temporal] Separated: 2 new events, 0 references
[Semantic Dedup] Starting deduplication for 2 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Processing cluster with 2 entities: VP shunt, VP shunt
[Semantic Dedup] Merged 2 entities on no_date → "VP shunt"
[Semantic Dedup] Deduplication complete: 2 → 1 procedures
[Semantic Dedup] Procedures: 2 → 1 (50.0% reduction)
[Semantic Dedup] Merged 1 procedure groups (avg 2.0 per group)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'HYDROCEPHALUS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 4024 → 176 chars, Notes 199 → 199 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 6/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 45.6%
[Phase 3] Quality score: 45.6%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 49.6%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 14097ms
[Orchestrator] Final quality: 49.6%
❌ FAILED
   Quality: N/A% (expected: 35%)
   Duration: 14.1s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 7/25: Missing Demographics [MALFORMED]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:54:40.827Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:54:40.827Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: { ictusDate: null, admissionDate: null, dischargeDate: null },
  pathology: {
    type: 'ICH',
    location: 'left basal ganglia',
    huntHess: null,
    fisher: null,
    size: '30cc'
  },
  presentingSymptoms: [],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: {
    findings: [ '30cc left basal ganglia hemorrhage' ],
    dates: [ null ]
  },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Rehab', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:40.827Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:40.827Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (52.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 1 complication mentions (before deduplication)
[Temporal] Separated: 1 new complications, 0 references
[Semantic Dedup] Starting deduplication for 1 complications...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 complications
[Semantic Dedup] Complications: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 1 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 1 events, 0 relationships, 0 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 24.2%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3798 → 150 chars, Notes 190 → 190 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 8/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 46.3%
[Phase 3] Quality score: 46.3%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 50.3%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 12185ms
[Orchestrator] Final quality: 50.3%
❌ FAILED
   Quality: N/A% (expected: 30%)
   Duration: 12.2s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 8/25: Incomplete Pathology [MALFORMED]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:54:53.300Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:54:53.300Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 52, gender: 'F' },
  dates: {
    ictusDate: null,
    admissionDate: '2025-05-01',
    dischargeDate: '2025-05-10'
  },
  pathology: {
    type: null,
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'neurological symptoms' ],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: {
    findings: [ 'CT performed', 'MRI performed' ],
    dates: [ '2025-05-01', '2025-05-01' ]
  },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:53.300Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:54:53.300Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (56.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 4 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3127 → 163 chars, Notes 192 → 192 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 6/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.1%
[Phase 3] Quality score: 48.1%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.1%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 12799ms
[Orchestrator] Final quality: 48.1%
❌ FAILED
   Quality: N/A% (expected: 25%)
   Duration: 12.8s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 9/25: Empty Fields [MALFORMED]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:55:05.353Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:55:05.353Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: { ictusDate: null, admissionDate: null, dischargeDate: null },
  pathology: {
    type: null,
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:05.353Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:05.353Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (47.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 0 events, 0 relationships, 0 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 24.2%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 2920 → 149 chars, Notes 44 → 44 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 1/8 sections extracted
[Narrative Validation] Section 'chiefComplaint' inadequate, using template fallback
[Narrative Validation] Section 'hospitalCourse' inadequate, using template fallback
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 5 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.2%
[Phase 3] Quality score: 48.2%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.2%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 9016ms
[Orchestrator] Final quality: 52.2%
❌ FAILED
   Quality: N/A% (expected: 10%)
   Duration: 9.0s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 10/25: Truncated Text [MALFORMED]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'SAH', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'SAH', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'SAH' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'SAH', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'gradingScales.huntHess',
    reason: 'Hunt-Hess grade is critical for SAH prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "Hunt-Hess", "H&H", "HH grade" in admission notes, neurosurgery consult, or imaging reports',
    clinicalSignificance: 'Predicts mortality: Grade 1-2 (10-20%), Grade 3 (30-40%), Grade 4-5 (60-80%). Guides ICU level of care.',
    relatedFields: [ 'gcs', 'neurologicalExam', 'admissionStatus' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  },
  {
    field: 'gradingScales.fisher',
    reason: 'Fisher grade predicts vasospasm risk - essential for monitoring plan',
    priority: 'critical',
    whereToFind: 'Look for: "Fisher", "Modified Fisher", "mFisher" in CT head reports or neurosurgery notes',
    clinicalSignificance: 'Grade 3 has 60-70% vasospasm risk. Determines TCD monitoring frequency and nimodipine duration.',
    relatedFields: [ 'imaging', 'vasospasmRisk', 'tcdMonitoring' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  },
  {
    field: 'aneurysm.location',
    reason: 'Aneurysm location affects treatment approach and follow-up',
    priority: 'high',
    whereToFind: 'Look for: "PCOM", "ACOM", "MCA", "basilar" in CTA/angiogram reports or operative notes',
    clinicalSignificance: 'Location determines surgical vs endovascular approach and recurrence risk.',
    relatedFields: [ 'procedure', 'imaging' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  },
  {
    field: 'aneurysm.size',
    reason: 'Aneurysm size affects rupture risk and treatment complexity',
    priority: 'high',
    whereToFind: 'Look for: size in mm in CTA/angiogram reports (e.g., "5mm aneurysm")',
    clinicalSignificance: 'Size >7mm = higher rupture risk. Larger aneurysms may require complex treatment.',
    relatedFields: [ 'aneurysm.location', 'procedure' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  },
  {
    field: 'medications.nimodipine',
    reason: 'Nimodipine is standard of care for SAH - should be documented',
    priority: 'high',
    whereToFind: 'Look for: "nimodipine", "Nimotop", "60mg q4h" in medication list',
    clinicalSignificance: 'Nimodipine reduces poor outcomes by 40%. Given for 21 days post-SAH.',
    relatedFields: [ 'medications', 'vasospasmPrevention' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:55:14.564Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 45, gender: 'M' },
  dates: {
    ictusDate: null,
    admissionDate: '2025-06-01',
    dischargeDate: '2025-06-15'
  },
  pathology: {
    type: 'SAH',
    location: null,
    huntHess: 3,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'gradingScales.huntHess',
      reason: 'Hunt-Hess grade is critical for SAH prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "Hunt-Hess", "H&H", "HH grade" in admission notes, neurosurgery consult, or imaging reports',
      clinicalSignificance: 'Predicts mortality: Grade 1-2 (10-20%), Grade 3 (30-40%), Grade 4-5 (60-80%). Guides ICU level of care.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    },
    {
      field: 'gradingScales.fisher',
      reason: 'Fisher grade predicts vasospasm risk - essential for monitoring plan',
      priority: 'critical',
      whereToFind: 'Look for: "Fisher", "Modified Fisher", "mFisher" in CT head reports or neurosurgery notes',
      clinicalSignificance: 'Grade 3 has 60-70% vasospasm risk. Determines TCD monitoring frequency and nimodipine duration.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    },
    {
      field: 'aneurysm.location',
      reason: 'Aneurysm location affects treatment approach and follow-up',
      priority: 'high',
      whereToFind: 'Look for: "PCOM", "ACOM", "MCA", "basilar" in CTA/angiogram reports or operative notes',
      clinicalSignificance: 'Location determines surgical vs endovascular approach and recurrence risk.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    },
    {
      field: 'aneurysm.size',
      reason: 'Aneurysm size affects rupture risk and treatment complexity',
      priority: 'high',
      whereToFind: 'Look for: size in mm in CTA/angiogram reports (e.g., "5mm aneurysm")',
      clinicalSignificance: 'Size >7mm = higher rupture risk. Larger aneurysms may require complex treatment.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    },
    {
      field: 'medications.nimodipine',
      reason: 'Nimodipine is standard of care for SAH - should be documented',
      priority: 'high',
      whereToFind: 'Look for: "nimodipine", "Nimotop", "60mg q4h" in medication list',
      clinicalSignificance: 'Nimodipine reduces poor outcomes by 40%. Given for 21 days post-SAH.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:14.564Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (51.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: SAH
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 24.2%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'SAH', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 5274 → 184 chars, Notes 162 → 162 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 44.9%
[Phase 3] Quality score: 44.9%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 44.9%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 11858ms
[Orchestrator] Final quality: 44.9%
❌ FAILED
   Quality: N/A% (expected: 20%)
   Duration: 11.9s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 11/25: Very Short Stay [BOUNDARY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:55:26.966Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:55:26.966Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 35, gender: 'M' },
  dates: {
    ictusDate: '2025-07-01',
    admissionDate: '2025-07-01',
    dischargeDate: '2025-07-01'
  },
  pathology: {
    type: 'TBI',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'loss of consciousness' ],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: {
    findings: [ 'CT head negative for acute pathology' ],
    dates: [ '2025-07-01' ]
  },
  functionalScores: { mRS: 0, KPS: 100, GCS: 15 },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:26.966Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:26.966Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (53.8%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 5 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3459 → 164 chars, Notes 256 → 256 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 49.1%
[Phase 3] Quality score: 49.1%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 49.1%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 13652ms
[Orchestrator] Final quality: 49.1%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 13.7s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 12/25: Very Long Stay [BOUNDARY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TBI_CSDH', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TBI_CSDH', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TBI_CSDH' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'TBI_CSDH',
  consultants: 0,
  hasPTOT: false,
  complexity: 0
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'gcs.admission',
    reason: 'Admission GCS is fundamental for TBI severity classification',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale" in ED notes or admission notes',
    clinicalSignificance: 'GCS 13-15 = mild, 9-12 = moderate, 3-8 = severe. Determines treatment intensity.',
    relatedFields: [ 'neurologicalExam', 'prognosis' ],
    timestamp: '2025-10-16T17:55:43.430Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:55:43.430Z'
  },
  {
    field: 'imaging.marshallGrade',
    reason: 'Marshall CT classification predicts outcome in TBI',
    priority: 'high',
    whereToFind: 'Look for: "Marshall", "diffuse injury" in CT head reports',
    clinicalSignificance: 'Marshall grade correlates with mortality (Grade 1 = 10%, Grade 4 = 55%).',
    relatedFields: [ 'imaging', 'prognosis', 'icpManagement' ],
    timestamp: '2025-10-16T17:55:43.430Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:55:43.430Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 28, gender: 'M' },
  dates: {
    ictusDate: '2025-08-01',
    admissionDate: '2025-08-01',
    dischargeDate: '2025-11-05'
  },
  pathology: {
    type: 'TBI',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'severe traumatic brain injury', 'decreased consciousness' ],
  procedures: [
    {
      name: 'decompressive craniectomy',
      date: '2025-08-01',
      operator: null
    },
    { name: 'tracheostomy', date: '2025-08-31', operator: null },
    { name: 'PEG placement', date: '2025-08-31', operator: null },
    { name: 'cranioplasty', date: '2025-09-30', operator: null }
  ],
  complications: [
    {
      name: 'ventilator-associated pneumonia',
      date: null,
      severity: null,
      management: null
    },
    { name: 'sepsis', date: null, severity: null, management: null },
    {
      name: 'deep vein thrombosis',
      date: null,
      severity: null,
      management: null
    }
  ],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: 4 },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'LTAC', support: null },
  _suggestions: [
    {
      field: 'gcs.admission',
      reason: 'Admission GCS is fundamental for TBI severity classification',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale" in ED notes or admission notes',
      clinicalSignificance: 'GCS 13-15 = mild, 9-12 = moderate, 3-8 = severe. Determines treatment intensity.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:43.430Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:43.430Z'
    },
    {
      field: 'imaging.marshallGrade',
      reason: 'Marshall CT classification predicts outcome in TBI',
      priority: 'high',
      whereToFind: 'Look for: "Marshall", "diffuse injury" in CT head reports',
      clinicalSignificance: 'Marshall grade correlates with mortality (Grade 1 = 10%, Grade 4 = 55%).',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:43.430Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:55:43.430Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (53.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TBI_CSDH
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 5 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 5 references
[Reference Linking] Linked 0 of 5 references
[Phase 1 Step 5] Procedure extraction complete: 5 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 2 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 2 references
[Reference Linking] Linked 0 of 2 complication references
[Phase 1 Step 5] Complication extraction complete: 2 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 3 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 29.1%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TBI_CSDH', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 8591 → 332 chars, Notes 376 → 376 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.5%
[Phase 3] Quality score: 48.5%
LLM narrative generation successful
[PerformanceMonitor] ⚠️  SLOW OPERATION: Phase 3: Narrative Generation (narrative) took 12878ms
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.5%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 20149ms
[Orchestrator] Final quality: 48.5%
❌ FAILED
   Quality: N/A% (expected: 50%)
   Duration: 20.1s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 13/25: Patient Expired [BOUNDARY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:56:00.916Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:56:00.916Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 82, gender: 'F' },
  dates: {
    ictusDate: '2025-09-01',
    admissionDate: '2025-09-01',
    dischargeDate: '2025-09-03'
  },
  pathology: {
    type: 'ICH',
    location: null,
    huntHess: null,
    fisher: null,
    size: 'massive'
  },
  presentingSymptoms: [ 'altered mental status' ],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: 6, KPS: 0, GCS: 3 },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Expired', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:00.916Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:00.916Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (49.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 2 complication mentions (before deduplication)
[Temporal] Separated: 2 new complications, 0 references
[Semantic Dedup] Starting deduplication for 2 complications...
[Semantic Dedup] Created 2 semantic clusters
[Semantic Dedup] Deduplication complete: 2 → 2 complications
[Semantic Dedup] Complications: 2 → 2 (0.0% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 2 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 5 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 4607 → 164 chars, Notes 271 → 271 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 5/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.2%
[Phase 3] Quality score: 51.2%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.2%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 11461ms
[Orchestrator] Final quality: 51.2%
❌ FAILED
   Quality: N/A% (expected: 40%)
   Duration: 11.5s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 14/25: Left AMA [BOUNDARY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TBI_CSDH', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TBI_CSDH', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TBI_CSDH' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'TBI_CSDH',
  consultants: 0,
  hasPTOT: false,
  complexity: 0
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'gcs.admission',
    reason: 'Admission GCS is fundamental for TBI severity classification',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale" in ED notes or admission notes',
    clinicalSignificance: 'GCS 13-15 = mild, 9-12 = moderate, 3-8 = severe. Determines treatment intensity.',
    relatedFields: [ 'neurologicalExam', 'prognosis' ],
    timestamp: '2025-10-16T17:56:11.939Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:56:11.939Z'
  },
  {
    field: 'imaging.marshallGrade',
    reason: 'Marshall CT classification predicts outcome in TBI',
    priority: 'high',
    whereToFind: 'Look for: "Marshall", "diffuse injury" in CT head reports',
    clinicalSignificance: 'Marshall grade correlates with mortality (Grade 1 = 10%, Grade 4 = 55%).',
    relatedFields: [ 'imaging', 'prognosis', 'icpManagement' ],
    timestamp: '2025-10-16T17:56:11.939Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:56:11.939Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 42, gender: 'M' },
  dates: {
    ictusDate: null,
    admissionDate: '2025-10-01',
    dischargeDate: '2025-10-02'
  },
  pathology: {
    type: 'SDH',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'gcs.admission',
      reason: 'Admission GCS is fundamental for TBI severity classification',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale" in ED notes or admission notes',
      clinicalSignificance: 'GCS 13-15 = mild, 9-12 = moderate, 3-8 = severe. Determines treatment intensity.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:11.939Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:11.939Z'
    },
    {
      field: 'imaging.marshallGrade',
      reason: 'Marshall CT classification predicts outcome in TBI',
      priority: 'high',
      whereToFind: 'Look for: "Marshall", "diffuse injury" in CT head reports',
      clinicalSignificance: 'Marshall grade correlates with mortality (Grade 1 = 10%, Grade 4 = 55%).',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:11.939Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:11.939Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (54.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TBI_CSDH
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 0 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 1 complication mentions (before deduplication)
[Temporal] Separated: 1 new complications, 0 references
[Semantic Dedup] Starting deduplication for 1 complications...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 complications
[Semantic Dedup] Complications: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 1 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 24.2%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TBI_CSDH', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 5343 → 187 chars, Notes 359 → 359 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 6/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 44.5%
[Phase 3] Quality score: 44.5%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.5%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 13809ms
[Orchestrator] Final quality: 48.5%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 13.8s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 15/25: Transfer [BOUNDARY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:56:26.007Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:56:26.007Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 68, gender: 'M' },
  dates: {
    ictusDate: '2025-11-01',
    admissionDate: '2025-11-01',
    dischargeDate: '2025-11-02'
  },
  pathology: {
    type: 'spine fracture',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [ [Object] ], imaging: [] },
  dischargeDestination: { location: 'Tertiary Spine Center', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:26.007Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:26.007Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (51.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 3 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 24.2%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3130 → 175 chars, Notes 301 → 301 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 8/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] Enhancing follow-up plan
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 47.4%
[Phase 3] Quality score: 47.4%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 47.4%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 11738ms
[Orchestrator] Final quality: 47.4%
❌ FAILED
   Quality: N/A% (expected: 40%)
   Duration: 11.7s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 16/25: Newborn Patient [EXTREME]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'HYDROCEPHALUS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'HYDROCEPHALUS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'HYDROCEPHALUS' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'HYDROCEPHALUS',
  consultants: 0,
  hasPTOT: false,
  complexity: 0
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:56:38.799Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:56:38.799Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 0, gender: 'F' },
  dates: {
    ictusDate: '2025-12-01',
    admissionDate: '2025-12-01',
    dischargeDate: '2025-12-10'
  },
  pathology: {
    type: 'hydrocephalus',
    location: 'congenital ventriculomegaly',
    huntHess: null,
    fisher: null,
    size: 'severe'
  },
  presentingSymptoms: [ 'ventriculomegaly' ],
  procedures: [
    { name: 'VP shunt placement', date: '2025-12-02', operator: null }
  ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [ 'severe ventriculomegaly' ], dates: [ '2025-12-01' ] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [ [Object] ], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:38.799Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:38.799Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (59.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: HYDROCEPHALUS
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 2 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 1 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 1 references
[Phase 1 Step 5] Procedure extraction complete: 2 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 1 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 1 references
[Reference Linking] Linked 0 of 1 complication references
[Phase 1 Step 5] Complication extraction complete: 1 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 4 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'HYDROCEPHALUS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 5306 → 221 chars, Notes 268 → 268 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 8/8 sections extracted
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 2 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 50.1%
[Phase 3] Quality score: 50.1%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 50.1%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 16545ms
[Orchestrator] Final quality: 50.1%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 16.5s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 17/25: Centenarian Patient [EXTREME]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TBI_CSDH', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TBI_CSDH', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TBI_CSDH' ]
Attempting LLM extraction...
🧠 Context built for extraction: {
  pathology: 'TBI_CSDH',
  consultants: 0,
  hasPTOT: false,
  complexity: 0
}
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'gcs.admission',
    reason: 'Admission GCS is fundamental for TBI severity classification',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale" in ED notes or admission notes',
    clinicalSignificance: 'GCS 13-15 = mild, 9-12 = moderate, 3-8 = severe. Determines treatment intensity.',
    relatedFields: [ 'neurologicalExam', 'prognosis' ],
    timestamp: '2025-10-16T17:56:54.262Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:56:54.262Z'
  },
  {
    field: 'imaging.marshallGrade',
    reason: 'Marshall CT classification predicts outcome in TBI',
    priority: 'high',
    whereToFind: 'Look for: "Marshall", "diffuse injury" in CT head reports',
    clinicalSignificance: 'Marshall grade correlates with mortality (Grade 1 = 10%, Grade 4 = 55%).',
    relatedFields: [ 'imaging', 'prognosis', 'icpManagement' ],
    timestamp: '2025-10-16T17:56:54.262Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:56:54.262Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 102, gender: 'F' },
  dates: {
    ictusDate: null,
    admissionDate: '2026-01-01',
    dischargeDate: '2026-01-15'
  },
  pathology: {
    type: 'CSDH',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [ { name: 'burr hole drainage', date: null, operator: null } ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [ 'SDH enlargement' ], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Assisted Living', support: null },
  _suggestions: [
    {
      field: 'gcs.admission',
      reason: 'Admission GCS is fundamental for TBI severity classification',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale" in ED notes or admission notes',
      clinicalSignificance: 'GCS 13-15 = mild, 9-12 = moderate, 3-8 = severe. Determines treatment intensity.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:54.262Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:54.262Z'
    },
    {
      field: 'imaging.marshallGrade',
      reason: 'Marshall CT classification predicts outcome in TBI',
      priority: 'high',
      whereToFind: 'Look for: "Marshall", "diffuse injury" in CT head reports',
      clinicalSignificance: 'Marshall grade correlates with mortality (Grade 1 = 10%, Grade 4 = 55%).',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:54.262Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:56:54.262Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (52.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TBI_CSDH
[Phase 1 Step 6] No detailed subtype detected (using basic pathology info)
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 0 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 4 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TBI_CSDH', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 4574 → 193 chars, Notes 242 → 242 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 44.0%
[Phase 3] Quality score: 44.0%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 44.0%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 11262ms
[Orchestrator] Final quality: 44.0%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 11.3s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 18/25: Comatose Patient [EXTREME]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:57:06.856Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:57:06.856Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 19, gender: 'M' },
  dates: {
    ictusDate: '2026-02-01',
    admissionDate: '2026-02-01',
    dischargeDate: '2026-02-28'
  },
  pathology: {
    type: 'anoxic brain injury',
    location: 'diffuse',
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'unresponsiveness', 'drowning' ],
  procedures: [
    {
      name: 'therapeutic hypothermia',
      date: '2026-02-01',
      operator: null
    },
    { name: 'PEG placement', date: null, operator: null },
    { name: 'tracheostomy', date: null, operator: null }
  ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: {
    findings: [ 'severe anoxic brain injury' ],
    dates: [ '2026-02-01' ]
  },
  functionalScores: { mRS: 5, KPS: 10, GCS: 3 },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'LTAC', support: '24/7 care' },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:06.856Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:06.856Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (54.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 0 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 0 references
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 0 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 5 events, 0 relationships, 3 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3855 → 180 chars, Notes 310 → 310 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 2 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.7%
[Phase 3] Quality score: 51.7%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.7%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 14741ms
[Orchestrator] Final quality: 51.7%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 14.7s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 19/25: Many Medications [EXTREME]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TUMORS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TUMORS', 'SEIZURES' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'tumor.histology',
    reason: 'Histology determines prognosis and treatment plan',
    priority: 'critical',
    whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
    clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
    relatedFields: [ 'tumor.whoGrade', 'molecularMarkers', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:57:23.237Z'
  },
  {
    field: 'tumor.whoGrade',
    reason: 'WHO grade is essential for prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
    clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
    relatedFields: [ 'tumor.histology', 'adjuvantTherapy', 'followUpSchedule' ],
    timestamp: '2025-10-16T17:57:23.237Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:57:23.237Z'
  },
  {
    field: 'resectionExtent',
    reason: 'Extent of resection affects survival and recurrence risk',
    priority: 'high',
    whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
    clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
    relatedFields: [ 'postopMRI', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:57:23.237Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:57:23.237Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 75, gender: 'M' },
  dates: { admissionDate: '2026-03-01', dischargeDate: null, ictusDate: null },
  pathology: {
    type: 'brain tumor',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [ { name: 'tumor resection', date: null, operator: null } ],
  complications: [],
  anticoagulation: { medications: [ [Object], [Object] ], critical: true },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [
    {
      name: 'metformin',
      dose: '1000mg',
      frequency: 'BID',
      route: 'oral'
    },
    { name: 'dexamethasone', dose: null, frequency: null, route: null },
    { name: 'levetiracetam', dose: null, frequency: null, route: null },
    { name: 'pantoprazole', dose: null, frequency: null, route: 'IV' }
  ],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'tumor.histology',
      reason: 'Histology determines prognosis and treatment plan',
      priority: 'critical',
      whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
      clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:23.237Z'
    },
    {
      field: 'tumor.whoGrade',
      reason: 'WHO grade is essential for prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
      clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:23.237Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:23.237Z'
    },
    {
      field: 'resectionExtent',
      reason: 'Extent of resection affects survival and recurrence risk',
      priority: 'high',
      whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
      clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:23.237Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:23.237Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (59.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TUMORS
[Phase 1 Step 6] Detected TUMORS subtype: { molecularMarkers: [] }
[Phase 1 Step 6] Subtype detection complete:
        - Type: TUMORS
        - Risk Level: MODERATE
        - Details: {
  "molecularMarkers": []
}
        - Prognosis: {}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 0 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 27 medication mentions (before deduplication)
[Temporal] Separated: 27 new prescriptions, 0 references
[Semantic Dedup] Starting deduplication for 27 medications...
[Semantic Dedup] Created 22 semantic clusters
[Semantic Dedup] Processing cluster with 2 entities: Atorvastatin, Atorvastatin
[Semantic Dedup] Processing cluster with 2 entities: Aspirin, Aspirin
[Semantic Dedup] Processing cluster with 2 entities: Clopidogrel, Clopidogrel
[Semantic Dedup] Processing cluster with 2 entities: Metoprolol, Metoprolol
[Semantic Dedup] Processing cluster with 2 entities: Levothyroxine, levetiracetam
[Semantic Dedup] Deduplication complete: 27 → 27 medications
[Semantic Dedup] Medications: 27 → 27 (0.0% reduction)
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 27 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 1 events, 0 relationships, 1 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 7752 → 228 chars, Notes 851 → 851 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 4 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.9%
[Phase 3] Quality score: 52.9%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.9%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 17199ms
[Orchestrator] Final quality: 52.9%
❌ FAILED
   Quality: N/A% (expected: 50%)
   Duration: 17.2s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 20/25: Many Complications [EXTREME]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TUMORS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TUMORS', 'CSF_LEAK', 'SEIZURES' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'tumor.histology',
    reason: 'Histology determines prognosis and treatment plan',
    priority: 'critical',
    whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
    clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
    relatedFields: [ 'tumor.whoGrade', 'molecularMarkers', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:57:42.804Z'
  },
  {
    field: 'tumor.whoGrade',
    reason: 'WHO grade is essential for prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
    clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
    relatedFields: [ 'tumor.histology', 'adjuvantTherapy', 'followUpSchedule' ],
    timestamp: '2025-10-16T17:57:42.804Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:57:42.804Z'
  },
  {
    field: 'resectionExtent',
    reason: 'Extent of resection affects survival and recurrence risk',
    priority: 'high',
    whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
    clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
    relatedFields: [ 'postopMRI', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:57:42.804Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:57:42.804Z'
  }
]
LLM extraction raw result: {
  demographics: { age: 55, gender: 'M' },
  dates: {
    ictusDate: null,
    admissionDate: '2026-04-01',
    dischargeDate: '2026-05-15'
  },
  pathology: {
    type: 'brain tumor',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [ { name: 'GBM resection', date: '2026-04-01', operator: null } ],
  complications: [
    {
      name: 'wound infection',
      date: '2026-04-04',
      severity: null,
      management: null
    },
    {
      name: 'CSF leak',
      date: '2026-04-06',
      severity: null,
      management: null
    },
    {
      name: 'pseudomeningocele',
      date: '2026-04-08',
      severity: null,
      management: null
    },
    {
      name: 'seizures',
      date: '2026-04-09',
      severity: null,
      management: null
    },
    {
      name: 'DVT',
      date: '2026-04-11',
      severity: null,
      management: null
    },
    {
      name: 'pulmonary embolism',
      date: '2026-04-12',
      severity: null,
      management: null
    },
    {
      name: 'acute kidney injury',
      date: '2026-04-13',
      severity: null,
      management: null
    },
    {
      name: 'atrial fibrillation',
      date: '2026-04-15',
      severity: null,
      management: null
    },
    {
      name: 'pneumonia',
      date: '2026-04-17',
      severity: null,
      management: null
    },
    {
      name: 'C. diff colitis',
      date: '2026-04-21',
      severity: null,
      management: null
    },
    {
      name: 'hyponatremia',
      date: '2026-04-23',
      severity: null,
      management: null
    },
    {
      name: 'pressure ulcer',
      date: '2026-04-26',
      severity: null,
      management: null
    }
  ],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Rehab', support: null },
  _suggestions: [
    {
      field: 'tumor.histology',
      reason: 'Histology determines prognosis and treatment plan',
      priority: 'critical',
      whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
      clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:42.804Z'
    },
    {
      field: 'tumor.whoGrade',
      reason: 'WHO grade is essential for prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
      clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:42.804Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:42.804Z'
    },
    {
      field: 'resectionExtent',
      reason: 'Extent of resection affects survival and recurrence risk',
      priority: 'high',
      whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
      clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:42.804Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:42.804Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (53.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TUMORS
[Phase 1 Step 6] Detected TUMORS subtype: {
  whoGrade: 'WHO Grade IV',
  treatment: [
    'Maximal safe resection',
    'Stupp protocol: RT + concurrent/adjuvant TMZ',
    'TTFields if eligible'
  ],
  molecularMarkers: []
}
[Phase 1 Step 6] Subtype detection complete:
        - Type: TUMORS
        - Risk Level: VERY HIGH
        - Details: {
  "whoGrade": "WHO Grade IV",
  "treatment": [
    "Maximal safe resection",
    "Stupp protocol: RT + concurrent/adjuvant TMZ",
    "TTFields if eligible"
  ],
  "molecularMarkers": []
}
        - Prognosis: {
  "survival": "17 months median survival",
  "malignancy": "Highly malignant",
  "growth": "Aggressive, necrosis, vascular proliferation",
  "factors": [
    "STR: +10% survival"
  ]
}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 0 new events, 1 references
[Reference Linking] Linked 0 of 1 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 10 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 10 references
[Reference Linking] Linked 0 of 10 complication references
[Phase 1 Step 5] Complication extraction complete: 10 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 15578 → 665 chars, Notes 546 → 546 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 5/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.3%
[Phase 3] Quality score: 52.3%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 52.3%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 21398ms
[Orchestrator] Final quality: 52.3%
❌ FAILED
   Quality: N/A% (expected: 50%)
   Duration: 21.4s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 21/25: Inconsistent Terminology [DATA_QUALITY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'SAH', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'SAH', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'SAH' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'SAH', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'gradingScales.huntHess',
    reason: 'Hunt-Hess grade is critical for SAH prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "Hunt-Hess", "H&H", "HH grade" in admission notes, neurosurgery consult, or imaging reports',
    clinicalSignificance: 'Predicts mortality: Grade 1-2 (10-20%), Grade 3 (30-40%), Grade 4-5 (60-80%). Guides ICU level of care.',
    relatedFields: [ 'gcs', 'neurologicalExam', 'admissionStatus' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  },
  {
    field: 'gradingScales.fisher',
    reason: 'Fisher grade predicts vasospasm risk - essential for monitoring plan',
    priority: 'critical',
    whereToFind: 'Look for: "Fisher", "Modified Fisher", "mFisher" in CT head reports or neurosurgery notes',
    clinicalSignificance: 'Grade 3 has 60-70% vasospasm risk. Determines TCD monitoring frequency and nimodipine duration.',
    relatedFields: [ 'imaging', 'vasospasmRisk', 'tcdMonitoring' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  },
  {
    field: 'aneurysm.location',
    reason: 'Aneurysm location affects treatment approach and follow-up',
    priority: 'high',
    whereToFind: 'Look for: "PCOM", "ACOM", "MCA", "basilar" in CTA/angiogram reports or operative notes',
    clinicalSignificance: 'Location determines surgical vs endovascular approach and recurrence risk.',
    relatedFields: [ 'procedure', 'imaging' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  },
  {
    field: 'aneurysm.size',
    reason: 'Aneurysm size affects rupture risk and treatment complexity',
    priority: 'high',
    whereToFind: 'Look for: size in mm in CTA/angiogram reports (e.g., "5mm aneurysm")',
    clinicalSignificance: 'Size >7mm = higher rupture risk. Larger aneurysms may require complex treatment.',
    relatedFields: [ 'aneurysm.location', 'procedure' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  },
  {
    field: 'medications.nimodipine',
    reason: 'Nimodipine is standard of care for SAH - should be documented',
    priority: 'high',
    whereToFind: 'Look for: "nimodipine", "Nimotop", "60mg q4h" in medication list',
    clinicalSignificance: 'Nimodipine reduces poor outcomes by 40%. Given for 21 days post-SAH.',
    relatedFields: [ 'medications', 'vasospasmPrevention' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:57:59.787Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: { ictusDate: null, admissionDate: '2026-05-01', dischargeDate: null },
  pathology: {
    type: 'aSAH',
    location: 'PCOM artery aneurysm',
    huntHess: 3,
    fisher: 4,
    size: null
  },
  presentingSymptoms: [ 'subarachnoid hemorrhage' ],
  procedures: [ { name: 'coiling', date: null, operator: null } ],
  complications: [
    {
      name: 'vasospasm monitoring',
      date: null,
      severity: null,
      management: 'TCD studies daily'
    }
  ],
  anticoagulation: { medications: [], critical: false },
  imaging: {
    findings: [ 'aneurysm obliteration on post-coil angiography' ],
    dates: [ null ]
  },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'gradingScales.huntHess',
      reason: 'Hunt-Hess grade is critical for SAH prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "Hunt-Hess", "H&H", "HH grade" in admission notes, neurosurgery consult, or imaging reports',
      clinicalSignificance: 'Predicts mortality: Grade 1-2 (10-20%), Grade 3 (30-40%), Grade 4-5 (60-80%). Guides ICU level of care.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    },
    {
      field: 'gradingScales.fisher',
      reason: 'Fisher grade predicts vasospasm risk - essential for monitoring plan',
      priority: 'critical',
      whereToFind: 'Look for: "Fisher", "Modified Fisher", "mFisher" in CT head reports or neurosurgery notes',
      clinicalSignificance: 'Grade 3 has 60-70% vasospasm risk. Determines TCD monitoring frequency and nimodipine duration.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    },
    {
      field: 'aneurysm.location',
      reason: 'Aneurysm location affects treatment approach and follow-up',
      priority: 'high',
      whereToFind: 'Look for: "PCOM", "ACOM", "MCA", "basilar" in CTA/angiogram reports or operative notes',
      clinicalSignificance: 'Location determines surgical vs endovascular approach and recurrence risk.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    },
    {
      field: 'aneurysm.size',
      reason: 'Aneurysm size affects rupture risk and treatment complexity',
      priority: 'high',
      whereToFind: 'Look for: size in mm in CTA/angiogram reports (e.g., "5mm aneurysm")',
      clinicalSignificance: 'Size >7mm = higher rupture risk. Larger aneurysms may require complex treatment.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    },
    {
      field: 'medications.nimodipine',
      reason: 'Nimodipine is standard of care for SAH - should be documented',
      priority: 'high',
      whereToFind: 'Look for: "nimodipine", "Nimotop", "60mg q4h" in medication list',
      clinicalSignificance: 'Nimodipine reduces poor outcomes by 40%. Given for 21 days post-SAH.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:57:59.787Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (54.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: SAH
[Phase 1 Step 6] Detected SAH subtype: {
  aneurysmLocation: 'Posterior Communicating Artery',
  locationRisks: [ 'CN III palsy', 'Carotid cave location' ],
  surgicalDifficulty: 'MODERATE',
  vasospasmRisk: '30-40%'
}
[Phase 1 Step 6] Subtype detection complete:
        - Type: SAH
        - Risk Level: MODERATE
        - Details: {
  "aneurysmLocation": "Posterior Communicating Artery",
  "locationRisks": [
    "CN III palsy",
    "Carotid cave location"
  ],
  "surgicalDifficulty": "MODERATE",
  "vasospasmRisk": "30-40%"
}
        - Prognosis: {
  "mortality": "15-20%",
  "goodOutcome": "60-70% (mRS 0-2)",
  "vasospasmRisk": "30-40%"
}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 2 procedure mentions (before deduplication)
[Temporal] Separated: 2 new events, 0 references
[Semantic Dedup] Starting deduplication for 2 procedures...
[Semantic Dedup] Created 2 semantic clusters
[Semantic Dedup] Deduplication complete: 2 → 2 procedures
[Semantic Dedup] Procedures: 2 → 2 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 2 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 2 complication mentions (before deduplication)
[Temporal] Separated: 2 new complications, 0 references
[Semantic Dedup] Starting deduplication for 2 complications...
[Semantic Dedup] Created 2 semantic clusters
[Semantic Dedup] Deduplication complete: 2 → 2 complications
[Semantic Dedup] Complications: 2 → 2 (0.0% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 2 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 1 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 29.1%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'SAH', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 9541 → 259 chars, Notes 359 → 359 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 6/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 51.4%
[Phase 3] Quality score: 51.4%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 55.4%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 14652ms
[Orchestrator] Final quality: 55.4%
❌ FAILED
   Quality: N/A% (expected: 45%)
   Duration: 14.7s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 22/25: Duplicate Entries [DATA_QUALITY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TUMORS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TUMORS' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'tumor.histology',
    reason: 'Histology determines prognosis and treatment plan',
    priority: 'critical',
    whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
    clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
    relatedFields: [ 'tumor.whoGrade', 'molecularMarkers', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:58:13.945Z'
  },
  {
    field: 'tumor.whoGrade',
    reason: 'WHO grade is essential for prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
    clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
    relatedFields: [ 'tumor.histology', 'adjuvantTherapy', 'followUpSchedule' ],
    timestamp: '2025-10-16T17:58:13.945Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:58:13.945Z'
  },
  {
    field: 'resectionExtent',
    reason: 'Extent of resection affects survival and recurrence risk',
    priority: 'high',
    whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
    clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
    relatedFields: [ 'postopMRI', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:58:13.945Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:58:13.945Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: {
    ictusDate: null,
    admissionDate: '2026-06-01',
    dischargeDate: '2026-06-01'
  },
  pathology: {
    type: 'brain tumor',
    location: 'left temporal',
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [ { name: 'craniotomy', date: '2026-06-01', operator: null } ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [
    {
      name: 'dexamethasone',
      dose: '4mg',
      frequency: 'q6h',
      route: null
    }
  ],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: 'Home', support: null },
  _suggestions: [
    {
      field: 'tumor.histology',
      reason: 'Histology determines prognosis and treatment plan',
      priority: 'critical',
      whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
      clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:13.945Z'
    },
    {
      field: 'tumor.whoGrade',
      reason: 'WHO grade is essential for prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
      clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:13.945Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:13.945Z'
    },
    {
      field: 'resectionExtent',
      reason: 'Extent of resection affects survival and recurrence risk',
      priority: 'high',
      whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
      clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:13.945Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:13.945Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (51.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TUMORS
[Phase 1 Step 6] Detected TUMORS subtype: { molecularMarkers: [] }
[Phase 1 Step 6] Subtype detection complete:
        - Type: TUMORS
        - Risk Level: MODERATE
        - Details: {
  "molecularMarkers": []
}
        - Prognosis: {}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 5 procedure mentions (before deduplication)
[Temporal] Separated: 5 new events, 0 references
[Semantic Dedup] Starting deduplication for 5 procedures...
[Semantic Dedup] Created 2 semantic clusters
[Semantic Dedup] Processing cluster with 4 entities: craniotomy for tumor resection, craniotomy, craniotomy, Craniotomy
[Semantic Dedup] Merged 4 entities on no_date → "craniotomy"
[Semantic Dedup] Deduplication complete: 5 → 2 procedures
[Semantic Dedup] Procedures: 5 → 2 (60.0% reduction)
[Semantic Dedup] Merged 1 procedure groups (avg 4.0 per group)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 2 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 5 medication mentions (before deduplication)
[Temporal] Separated: 5 new prescriptions, 0 references
[Semantic Dedup] Starting deduplication for 5 medications...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Processing cluster with 5 entities: Dexamethasone, dexamethasone, dexamethasone, Dexamethasone, dexamethasone
[Semantic Dedup] Deduplication complete: 5 → 5 medications
[Semantic Dedup] Medications: 5 → 5 (0.0% reduction)
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 5 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 7031 → 195 chars, Notes 337 → 337 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 4/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 45.0%
[Phase 3] Quality score: 45.0%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 49.0%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 14746ms
[Orchestrator] Final quality: 49.0%
❌ FAILED
   Quality: N/A% (expected: 40%)
   Duration: 14.7s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 23/25: Missing Procedure Details [DATA_QUALITY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:58:28.626Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:58:28.626Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: { ictusDate: null, admissionDate: '2026-07-01', dischargeDate: null },
  pathology: {
    type: null,
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [
    {
      name: 'unspecified surgical procedure',
      date: null,
      operator: null
    }
  ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:28.626Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:28.626Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (52.0%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 0 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 1 events, 0 relationships, 1 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3467 → 157 chars, Notes 139 → 139 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 7/8 sections extracted
[Narrative Validation] Section 'procedures' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 49.4%
[Phase 3] Quality score: 49.4%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 53.4%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 13720ms
[Orchestrator] Final quality: 53.4%
❌ FAILED
   Quality: N/A% (expected: 25%)
   Duration: 13.7s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 24/25: Ambiguous Information [DATA_QUALITY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'TUMORS', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: [ 'TUMORS', 'SEIZURES' ]
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'TUMORS', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'tumor.histology',
    reason: 'Histology determines prognosis and treatment plan',
    priority: 'critical',
    whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
    clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
    relatedFields: [ 'tumor.whoGrade', 'molecularMarkers', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:58:42.186Z'
  },
  {
    field: 'tumor.whoGrade',
    reason: 'WHO grade is essential for prognosis and treatment planning',
    priority: 'critical',
    whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
    clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
    relatedFields: [ 'tumor.histology', 'adjuvantTherapy', 'followUpSchedule' ],
    timestamp: '2025-10-16T17:58:42.187Z'
  },
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:58:42.187Z'
  },
  {
    field: 'resectionExtent',
    reason: 'Extent of resection affects survival and recurrence risk',
    priority: 'high',
    whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
    clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
    relatedFields: [ 'postopMRI', 'adjuvantTherapy' ],
    timestamp: '2025-10-16T17:58:42.187Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:58:42.187Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: { ictusDate: null, admissionDate: '2026-08-01', dischargeDate: null },
  pathology: {
    type: 'brain tumor',
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [ 'possible stroke', 'possible seizure' ],
  procedures: [],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [ 'possible lesion' ], dates: [ '2026-08-01' ] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [],
  followUp: { appointments: [ [Object] ], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'tumor.histology',
      reason: 'Histology determines prognosis and treatment plan',
      priority: 'critical',
      whereToFind: 'Look for: pathology report, "glioblastoma", "meningioma", "astrocytoma", "oligodendroglioma"',
      clinicalSignificance: 'Histology is THE most important prognostic factor. Guides all treatment decisions.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:42.186Z'
    },
    {
      field: 'tumor.whoGrade',
      reason: 'WHO grade is essential for prognosis and treatment planning',
      priority: 'critical',
      whereToFind: 'Look for: "WHO grade", "Grade I/II/III/IV" in pathology report',
      clinicalSignificance: 'Grade 1 = benign, Grade 4 = aggressive. Determines need for radiation/chemotherapy.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:42.187Z'
    },
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:42.187Z'
    },
    {
      field: 'resectionExtent',
      reason: 'Extent of resection affects survival and recurrence risk',
      priority: 'high',
      whereToFind: 'Look for: "GTR", "STR", "gross total", "subtotal", "biopsy only" in operative note',
      clinicalSignificance: 'GTR associated with longer survival. STR may require adjuvant radiation.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:42.187Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:42.187Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (59.5%)
⚠️ Quality Issues: detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 6] Detecting pathology subtypes...
[Phase 1 Step 6] Detecting subtype for: TUMORS
[Phase 1 Step 6] Detected TUMORS subtype: { molecularMarkers: [] }
[Phase 1 Step 6] Subtype detection complete:
        - Type: TUMORS
        - Risk Level: MODERATE
        - Details: {
  "molecularMarkers": []
}
        - Prognosis: {}
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 0 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 2 complication mentions (before deduplication)
[Temporal] Separated: 2 new complications, 0 references
[Semantic Dedup] Starting deduplication for 2 complications...
[Semantic Dedup] Created 2 semantic clusters
[Semantic Dedup] Deduplication complete: 2 → 2 complications
[Semantic Dedup] Complications: 2 → 2 (0.0% reduction)
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 2 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 1 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 25.8%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'TUMORS', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 7462 → 167 chars, Notes 235 → 235 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 6/8 sections extracted
[Narrative Validation] Section 'followUpPlan' inadequate, using template fallback
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 3 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.3%
[Phase 3] Quality score: 48.3%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 48.3%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 13058ms
[Orchestrator] Final quality: 48.3%
❌ FAILED
   Quality: N/A% (expected: 20%)
   Duration: 13.1s
   Structure: ✗ Incomplete

────────────────────────────────────────────────────────────────────────────────
TEST 25/25: Mixed Date Formats [DATA_QUALITY]
────────────────────────────────────────────────────────────────────────────────

[Orchestrator] Starting intelligent summary generation...
[Orchestrator] Context built: { pathology: 'general', complexity: 0 }
[Orchestrator] Extracting data from notes...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, complexity: 0 }
Could not load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:330:28)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:26)
    at runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:28)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
Preprocessing clinical notes for variable styles and formats...
✓ Preprocessing complete
Extraction method: LLM-enhanced
🔍 Detected pathologies: []
Attempting LLM extraction...
🧠 Context built for extraction: { pathology: 'general', consultants: 0, hasPTOT: false, complexity: 0 }
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at extractWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:611:24)
    at extractMedicalEntities (file:///Users/ramihatoum/Desktop/app/DCS/src/services/extraction.js:411:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:159:20)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for extraction task
💡 Suggested missing fields: [
  {
    field: 'examination.gcs',
    reason: 'GCS is fundamental for neurological assessment',
    priority: 'critical',
    whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
    clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
    relatedFields: [ 'neurologicalExam', 'mentalStatus' ],
    timestamp: '2025-10-16T17:58:55.717Z'
  },
  {
    field: 'functionalStatus',
    reason: 'Functional status (mRS or KPS) documents baseline and outcome',
    priority: 'medium',
    whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
    clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
    relatedFields: [ 'dischargeDestination', 'supportLevel', 'ptotAssessment' ],
    timestamp: '2025-10-16T17:58:55.717Z'
  }
]
LLM extraction raw result: {
  demographics: { age: null, gender: null },
  dates: {
    ictusDate: null,
    admissionDate: '2026-09-01',
    dischargeDate: '2026-09-20'
  },
  pathology: {
    type: null,
    location: null,
    huntHess: null,
    fisher: null,
    size: null
  },
  presentingSymptoms: [],
  procedures: [ { name: 'surgery', date: '2026-09-05', operator: null } ],
  complications: [],
  anticoagulation: { medications: [], critical: false },
  imaging: { findings: [], dates: [] },
  functionalScores: { mRS: null, KPS: null, GCS: null },
  medications: [ { name: null, dose: null, frequency: null, route: null } ],
  followUp: { appointments: [ [Object] ], imaging: [] },
  dischargeDestination: { location: null, support: null },
  _suggestions: [
    {
      field: 'examination.gcs',
      reason: 'GCS is fundamental for neurological assessment',
      priority: 'critical',
      whereToFind: 'Look for: "GCS", "Glasgow Coma Scale", "E_V_M_" in any clinical note',
      clinicalSignificance: 'GCS tracks neurological status. Decline ≥2 points requires immediate imaging.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:55.717Z'
    },
    {
      field: 'functionalStatus',
      reason: 'Functional status (mRS or KPS) documents baseline and outcome',
      priority: 'medium',
      whereToFind: 'Look for: "mRS", "Rankin", "KPS", "Karnofsky" or infer from discharge destination and support level',
      clinicalSignificance: 'mRS 0-2 = good outcome, 3-5 = poor outcome. Guides discharge planning.',
      relatedFields: [Array],
      timestamp: '2025-10-16T17:58:55.717Z'
    }
  ]
}
Running pattern extraction for data enrichment...
📊 Source Quality: POOR (57.5%)
⚠️ Quality Issues: completeness, detail
[Phase 1 Step 5] Reference dates for temporal resolution: { surgeryDates: [] }
[Phase 1 Step 5] Enhanced procedure extraction started...
[Extraction] Found 1 procedure mentions (before deduplication)
[Temporal] Separated: 1 new events, 0 references
[Semantic Dedup] Starting deduplication for 1 procedures...
[Semantic Dedup] Created 1 semantic clusters
[Semantic Dedup] Deduplication complete: 1 → 1 procedures
[Semantic Dedup] Procedures: 1 → 1 (0.0% reduction)
[Reference Linking] Linked 0 of 0 references
[Phase 1 Step 5] Procedure extraction complete: 1 procedures
[Phase 1 Step 5] Enhanced complication extraction started...
[Extraction] Found 0 complication mentions (before deduplication)
[Temporal] Separated: 0 new complications, 0 references
[Reference Linking] Linked 0 of 0 complication references
[Phase 1 Step 5] Complication extraction complete: 0 complications
[Phase 1 Step 5] Enhanced medication extraction started...
[Extraction] Found 0 medication mentions (before deduplication)
[Temporal] Separated: 0 new prescriptions, 0 references
[Reference Linking] Linked 0 of 0 medication references
[Phase 1 Step 5] Medication extraction complete: 0 medications
✅ Confidence scores calibrated based on source quality
LLM extraction successful with pattern enrichment
[Phase 2] Building causal timeline...
[Phase 2] Timeline built: 2 events, 0 relationships, 2 milestones
[Phase 2] Tracking treatment responses...
[Phase 2] Found 0 treatment-outcome pairs
[Phase 2 Step 4] Extracting clinical relationships...
[Phase 2 Step 4] Extracted 0 unique relationships
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 27.5%
[Orchestrator] Validating extraction...
[Orchestrator] Gathering comprehensive intelligence...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] Refinement iteration 1...
[Intelligence Hub] Gathering comprehensive intelligence...
[Intelligence Hub] Intelligence gathering complete
[Orchestrator] No quality improvement, stopping refinement
[Orchestrator] Generating narrative with intelligence context...
Narrative generation method: LLM-powered
Failed to load learned patterns: ReferenceError: indexedDB is not defined
    at openDB (file:///Users/ramihatoum/Desktop/app/DCS/node_modules/idb/build/index.js:168:21)
    at initLearningDB (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:40:16)
    at LearningEngine.initialize (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:128:23)
    at LearningEngine.getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1257:16)
    at getNarrativePatterns (file:///Users/ramihatoum/Desktop/app/DCS/src/services/ml/learningEngine.js:1331:76)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:125:32)
    at orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Attempting LLM narrative generation...
🧠 Context built for summary generation: { pathology: 'general', consultants: 0, complexity: 0 }
📊 Prompt optimization: Data 3856 → 176 chars, Notes 182 → 182 chars
Error loading LLM preferences: ReferenceError: localStorage is not defined
    at getPreferences (file:///Users/ramihatoum/Desktop/app/DCS/src/utils/llmPreferences.js:22:20)
    at getActiveLLMProvider (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:74:17)
    at callLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:143:40)
    at generateSummaryWithLLM (file:///Users/ramihatoum/Desktop/app/DCS/src/services/llmService.js:831:27)
    at generateNarrative (file:///Users/ramihatoum/Desktop/app/DCS/src/services/narrativeEngine.js:151:34)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async orchestrateSummaryGeneration (file:///Users/ramihatoum/Desktop/app/DCS/src/services/summaryOrchestrator.js:273:23)
    at async runEdgeCaseTests (file:///Users/ramihatoum/Desktop/app/DCS/docs/test-edge-cases.js:572:22)
Using Anthropic Claude 3.5 Sonnet for summarization task
LLM narrative parsed: 8/8 sections extracted
[Narrative Validation] Adding discharge instructions (commonly missing from LLM)
[Narrative Validation] Adding prognosis (commonly missing from LLM)
[Narrative Validation] ✓ Fixed/completed 2 narrative sections
[Narrative Validation] Section completion applied
[Phase 3] Applying narrative quality enhancements to LLM output...
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 50.2%
[Phase 3] Quality score: 50.2%
LLM narrative generation successful
[Quality Metrics] Calculating quality metrics...
[Quality Metrics] Overall quality score: 54.2%
[Intelligence Hub] Insight shared: ORCHESTRATION
[Orchestrator] Shared orchestration insights
[Orchestrator] Summary generation complete in 13987ms
[Orchestrator] Final quality: 54.2%
❌ FAILED
   Quality: N/A% (expected: 40%)
   Duration: 14.0s
   Structure: ✗ Incomplete


════════════════════════════════════════════════════════════════════════════════
  EDGE CASE TEST SUMMARY
════════════════════════════════════════════════════════════════════════════════

Total Tests: 25
✅ Passed: 0 (0.0%)
❌ Failed: 25 (100.0%)
💥 Crashed: 0 (0.0%)

By Category:
  CONCURRENT: 0/3 passed, 0 crashed
  MISSING_DATES: 0/3 passed, 0 crashed
  MALFORMED: 0/4 passed, 0 crashed
  BOUNDARY: 0/5 passed, 0 crashed
  EXTREME: 0/5 passed, 0 crashed
  DATA_QUALITY: 0/5 passed, 0 crashed

────────────────────────────────────────────────────────────────────────────────
ROBUSTNESS ANALYSIS:
────────────────────────────────────────────────────────────────────────────────

⚠️  FAIR: Many edge cases have quality issues, but no crashes

Robustness Score: 0.0%
Crash-Free: Yes ✅

Average Duration: 14.6s

════════════════════════════════════════════════════════════════════════════════

Edge case testing complete!
